<!DOCTYPE html>
<html>
<head>
<title>mysite</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<link rel="stylesheet" href="/assets/css/guestbook-spa.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script type="text/javascript" src="/assets/js/jquery/jquery-3.6.0.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="/assets/ejs/ejs.js" type="text/javascript"></script>
<script>
    
var isFetching = false;
var isEnd = false;

var listItemEJS = new EJS({
   	url: "/assets/ejs/listitem-template.ejs"
});

var listEJS = new EJS({
	url: "/assets/ejs/list-template.ejs"
});
    
var fetch = function(no) {
    if(isEnd){
		return;
    }
	if(isFetching){
	    return;
	}
    isFetching = !isFetching;
    
    $.ajax({
      	url: "/api/guestbook",
        dataType: "json",   
        data: {'no': no},
        type: "get",        
             
        success: function(response){
        	if(response.result != "success"){
				console.error(response.message);
				return;
			}
			// detect end
			if(response.data.length == 0){
				$(".btn-fetch").prop("disabled", true);
				return;
			}
    
            var html = listEJS.render(response);
            $("#list-guestbook").append(html);
            isFetching = !isFetching;
        },
        error: function(xhr, status, e){
			console.error(status + ":" + e);
		}
    });
};
    
var addGuestbook = function(){
     
    vo = {}
    vo.name = $("#input-name").val();  // .val()ì€ ì–‘ì‹(form)ì˜ ê°’ì„ ê°€ì ¸ì˜¤ê±°ë‚˜ ê°’ì„ ì„¤ì •í•˜ëŠ” ë©”ì†Œë“œì…ë‹ˆë‹¤.
    if(vo.name == "") {
        messageBox('ì˜¤ë¥˜', 'ì´ë¦„ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤.',function(){
			$("#input-name").focus();
		});
        return;
    }
    
    vo.password = $("#input-password").val();
    if(vo.password == "") {
        messageBox('ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.',function(){
				$("#input-password").focus();
	});
        return;
    }
    
    vo.message =  $("#tx-content").val()
    if(vo.message == "") {
        messageBox('ì˜¤ë¥˜', 'ë‚´ìš©ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤.', function(){
			$("#tx-content").focus();
		});
        return;
    }
    
    $.ajax({
        url: "/api/guestbook/add",
        dataType: "json",
        type: "post",
        contentType: "application/json",
        data: JSON.stringify(vo),
        success: function(response) {
            var vo = response.data;
            var html = listItemEJS.render(vo);
            $("#list-guestbook").prepend(html);
            
            $("#input-name").val("");       // ê°’ ì´ˆê¸°í™” 
            $("#input-password").val("");   
            $("#tx-content").val("");
        }
    });
};
 
 
var messageBox = function(title, message, callback) {
    $("#dialog-message").dialog({
        title: title,
        modal: true,
        buttons: {
            "ë‹«ê¸°": function(){
                $(this).dialog("close");
            }
        }
    });
    $("#dialog-message p").text(message);
    close: callback
};
 
 
$(function(){
     $("#add-form").submit(function(event){
         event.preventDefault();
         addGuestbook();
     });
     $("#btn-fetch").click(function(event){
         event.preventDefault(); 
         let no = $("#list-guestbook li:last-child").attr("data-no");
         fetch(no);
     });
     
     $(document).on("click", "#list-guestbook li a", function(event){
         event.preventDefault();
         let no = $(this).data("no");
         $("#hidden-no").val(no);
         console.log($("#hidden-no").val());
         deleteDialog.dialog("open");
     });
     
     $(window).scroll(function(){
 		var $window = $(this);
 		var windowHeight = $window.height();
 		var scrollTop = $window.scrollTop();
 		var documentHeight = $(document).height();
 		if(scrollTop +windowHeight + 10 > documentHeight){
 			let no = $("#list-guestbook li:last-child").attr("data-no");
 	        fetch(no);
 		}
 	});
     
     const deleteDialog = $("#dialog-delete-form").dialog({
        autoOpen: false,    
        width: 330,
        height: 270,
        modal: true,
        buttons: {
            "ì‚­ì œ": function(){
                const no = $("#hidden-no").val();
                const password = "password=" + $("#password-delete").val();
                console.log(password);
                console.log(no);
                $.ajax({
                    url: "/api/guestbook/" + no,
                    dataType: "json",
                    type: "delete",
                    data: password,
                    success: function(response){
                        console.log(response); // ë°‘ì— ì—ëŸ¬ì²˜ë¦¬
                        if(response.data == 'false'){
                            // ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦°ê²½ìš°
                            $(".validateTips.error").show();
                            
                            return;
                        }
                        
                        $("#list-guestbook li[data-no="+ response.data +"]").remove();
                        console.log(response.data);
                        deleteDialog.dialog("close");
                        
/*                      response.data.forEach(function(vo) {
                            // ëœë”ë§ì„ í•¨ìˆ˜ë¡œ ë§Œë“¤ê¸°
                            render(vo);
                            $("#list-guestbook").append(html);
                        }); */
                    }
                });
            },
            "ë‹«ê¸°": function(){
                $(this).dialog("close");
            }
        },
        close: function(){
            // 1. password ë¹„ìš°ê¸°
            // 2. no ë¹„ìš°ê¸°
            // 3. error message ìˆ¨ê¸°ê¸°
            
            console.log('==========ë‹¤ì´ì•Œë¡œê·¸ í¼ ë°ì´í„° ì •ë¦¬========');
            $("#password-delete").val("");
            $("#hidden-no").val("");
            $(".validateTips.error").hide(); 
            
        }
     });
     
     fetch(0); // ì´ˆê¸° ë°ì´í„° ì…‹íŒ…
 });
     
</script>
</head>
<body>
    <div id="container">
        <%-include('../includes/header')%>
        <div id="content">
            <div id="guestbook">
                <h1>ë°©ëª…ë¡</h1>
                <form id="add-form" action="api/guestbook/add" method="post">
                    <input type="text" id="input-name" placeholder="ì´ë¦„"> 
                    <input type="password" id="input-password" placeholder="ë¹„ë°€ë²ˆí˜¸">
                    <textarea id="tx-content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."></textarea>
                    <input type="submit" value="ğŸŒ¹ğŸŒ¹ğŸŒ¹" />
                </form>
 
 
 
                <ul id="list-guestbook">
 
                </ul>
 
                <div style="margin: 20px 0 0 0">
                    <button id="btn-fetch">ğŸ‘€ğŸ‘€</button>
                </div>
 
            </div>
            
            
            <div id="dialog-delete-form" title="ë©”ì„¸ì§€ ì‚­ì œ" style="display: none">
                <p class="validateTips normal">ì‘ì„±ì‹œ ì…ë ¥í–ˆë˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
                <p class="validateTips error" style="display: none">ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤.</p>
                <form>
                    <input type="password" name="password" id="password-delete" value="" class="text ui-widget-content ui-corner-all"> 
                    <input type="hidden" id="hidden-no" value=""> 
                    <input type="submit" tabindex="-1" style="position: absolute; top: -1000px">
                </form>
            </div>
            
            
            <div id="dialog-message" title="" style="display: none">
                <p></p>
            </div>
            
            
        </div>
        <%-include('../includes/navigation')%>
        <%-include('../includes/footer')%>
    </div>
</body>
</html>
